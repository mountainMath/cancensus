<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Finding intersecting geometries from custom data • cancensus</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link href="https://cdnjs.cloudflare.com/ajax/libs/bootswatch/3.4.0/simplex/bootstrap.min.css" rel="stylesheet" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><link href="../extra.css" rel="stylesheet">
<meta property="og:title" content="Finding intersecting geometries from custom data">
<meta property="og:description" content="cancensus">
<meta property="og:image" content="https://mountainmath.github.io/cancensus/logo.png">
<meta property="og:image:alt" content="cancensus">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:creator" content="@vb_jens">
<meta name="twitter:site" content="https://mountainmath.github.io/cancensus/">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]--><!-- Global site tag (gtag.js) - Google Analytics --><script async src="https://www.googletagmanager.com/gtag/js?id=UA-107390160-3"></script><script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'UA-107390160-3');
</script>
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">cancensus</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.4.3</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../articles/cancensus.html">Get started</a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/Making_maps_with_cancensus.html">Making maps with cancensus</a>
    </li>
    <li>
      <a href="../articles/data_discovery.html">Data discovery</a>
    </li>
    <li>
      <a href="../articles/intersecting_geometries.html">Finding intersecting geometries from custom data</a>
    </li>
    <li>
      <a href="../articles/Dwellings_by_document_type_cross_tabulation.html">Additional datasets: Structural type of dwelling by document type</a>
    </li>
    <li>
      <a href="../articles/Taxfiler_Data.html">Additional datasets: Annual T1FF taxfiler data</a>
    </li>
  </ul>
</li>
<li>
  <a href="../news/index.html">Changelog</a>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right">
<li>
  <a href="https://github.com/mountainMath/cancensus/">
    <span class="fab fa-github fa-lg"></span>
     
  </a>
</li>
      </ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><script src="intersecting_geometries_files/accessible-code-block-0.0.1/empty-anchor.js"></script><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Finding intersecting geometries from custom data</h1>
            <h3 class="subtitle">Bring custom data and identify corresponding census geographies</h3>
            
      
      <small class="dont-index">Source: <a href="https://github.com/mountainMath/cancensus/blob/master/vignettes/intersecting_geometries.Rmd"><code>vignettes/intersecting_geometries.Rmd</code></a></small>
      <div class="hidden name"><code>intersecting_geometries.Rmd</code></div>

    </div>

    
    
<p>A frequent application of census data is to evaluate values for specific areas that do not necessarily correspond to existing boundaries or administrative units. Census users may have their own defined geographies or other geospatial data of interest and want to be able to quickly and easily identify the collection of census features that correspond to that region.</p>
<p>The <code><a href="../reference/get_intersecting_geometries.html">get_intersecting_geometries()</a></code> function is projection agnostic and accepts any valid <code>sf</code> or <code>sfc</code> class object as input. These objects are then reprojected into lat/lon coordinates on the backend to facilitate the intersecting join on the server-side.</p>
<div id="a-simple-example" class="section level2">
<h2 class="hasAnchor">
<a href="#a-simple-example" class="anchor"></a>A simple example</h2>
<p>As an example, suppose we are interested in understanding the housing tenure split in census tracts located near Vancouver Skytrain (rapid transit) stations. We can use the <code>COV_SKYTRAIN_STATIONS</code> dataset that ships with the package and is derived from the <a href="https://opendata.vancouver.ca/explore/dataset/rapid-transit-stations/information/">City of Vancouver Open Data portal</a> and contains their locations. For our example we are interested in census tracts within 800m of these stations, which ships with the package.</p>
<div class="sourceCode" id="cb1"><pre class="downlit">
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://github.com/mountainMath/cancensus">cancensus</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://dplyr.tidyverse.org">dplyr</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://ggplot2.tidyverse.org">ggplot2</a></span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="kw"><a href="https://r-spatial.github.io/sf">sf</a></span>)
</pre></div>
<p>We load the example data <code>COV_SKYTRAIN_STATIONS</code> from the package.</p>
<div class="sourceCode" id="cb2"><pre class="downlit">
<span class="kw">cov_station_buffers</span> <span class="op">&lt;-</span> <span class="kw">COV_SKYTRAIN_STATIONS</span> <span class="op">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_crs.html">st_set_crs</a></span>(<span class="fl">4326</span>)  <span class="co"># needed for Ubuntu or systems with old GDAL but can otherwise be ignored</span>
</pre></div>
<p>We then use the <code>get_intersecting_geometries</code> call to obtain the list of municipalities (CSDs) and census tracts (CTs) that intersect the 800m station buffer objects.</p>
<div class="sourceCode" id="cb3"><pre class="downlit">
<span class="kw">station_city_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_intersecting_geometries.html">get_intersecting_geometries</a></span>(<span class="st">"CA16"</span>, level = <span class="st">"CSD"</span>, geometry = <span class="kw">cov_station_buffers</span>,
                                                quiet=<span class="fl">TRUE</span>)
<span class="kw">station_ct_ids</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_intersecting_geometries.html">get_intersecting_geometries</a></span>(<span class="st">"CA16"</span>, level = <span class="st">"CT"</span>, geometry = <span class="kw">cov_station_buffers</span>,
                                              quiet=<span class="fl">TRUE</span>)
</pre></div>
<p>These return a list of census geographic identifiers suitable for use in the ‘region’ argument in <code>get_census</code>. We may be interested in the transit to work mode share in each of these buffers.</p>
<div class="sourceCode" id="cb4"><pre class="downlit">
<span class="kw">variables</span> <span class="op">&lt;-</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(mode_base=<span class="st">"v_CA16_5792"</span>,transit=<span class="st">"v_CA16_5801"</span>,walk=<span class="st">"v_CA16_5804"</span>)
<span class="kw">station_city</span> <span class="op">&lt;-</span>  <span class="fu"><a href="../reference/get_census.html">get_census</a></span>(<span class="st">"CA16"</span>, regions = <span class="kw">station_city_ids</span>, vectors = <span class="kw">variables</span>, 
                            geo_format = <span class="st">'sf'</span>, quiet=<span class="fl">TRUE</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="https://dplyr.tidyverse.org/reference/filter.html">filter</a></span>(<span class="kw">name</span> <span class="op">==</span> <span class="st">"Vancouver (CY)"</span>)
<span class="kw">station_cts</span> <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/get_census.html">get_census</a></span>(<span class="st">"CA16"</span>, regions = <span class="kw">station_ct_ids</span>, vectors = <span class="kw">variables</span>, 
                            geo_format = <span class="st">'sf'</span>, quiet=<span class="fl">TRUE</span>)
</pre></div>
<p>To understand how these relate we plot the data.</p>
<div class="sourceCode" id="cb5"><pre class="downlit">
<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">station_city</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(fill=<span class="fl">NA</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(data=<span class="kw">station_cts</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(fill=((<span class="kw">walk</span><span class="op">+</span><span class="kw">transit</span>)<span class="op">/</span><span class="kw">mode_base</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(data=<span class="kw">cov_station_buffers</span>,fill=<span class="fl">NA</span>,alpha=<span class="fl">0.5</span>,color=<span class="st">"steelblue"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span>(option=<span class="st">"magma"</span>,labels=<span class="kw">scales</span>::<span class="kw"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span>(datum=<span class="fl">NA</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(title=<span class="st">"CTs within City of Vancouver skytrain station catchments"</span>,
       fill=<span class="st">"Walk or\ntransit\nto work"</span>,
       caption=<span class="st">"StatCan Census 2016"</span>)
</pre></div>
<p><img src="intersecting_geometries_files/figure-html/unnamed-chunk-5-1.png" width="700"></p>
<p>To get a closer match we can cut out the dissemination areas intersecting the station catchment areas.</p>
<div class="sourceCode" id="cb6"><pre class="downlit">
<span class="kw">station_das</span> <span class="op">&lt;-</span>   <span class="fu"><a href="../reference/get_intersecting_geometries.html">get_intersecting_geometries</a></span>(<span class="st">"CA16"</span>, level = <span class="st">"DA"</span>, geometry = <span class="kw">cov_station_buffers</span>,
                                             quiet=<span class="fl">TRUE</span>) <span class="op">%&gt;%</span> 
  <span class="fu"><a href="../reference/get_census.html">get_census</a></span>(<span class="st">"CA16"</span>, regions = <span class="kw">.</span>, vectors=<span class="kw">variables</span>, geo_format = <span class="st">'sf'</span>, quiet=<span class="fl">TRUE</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">station_city</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(fill=<span class="fl">NA</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(data=<span class="kw">station_das</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(fill=((<span class="kw">walk</span><span class="op">+</span><span class="kw">transit</span>)<span class="op">/</span><span class="kw">mode_base</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(data=<span class="kw">cov_station_buffers</span>,fill=<span class="fl">NA</span>,alpha=<span class="fl">0.5</span>,color=<span class="st">"steelblue"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span>(option=<span class="st">"magma"</span>,labels=<span class="kw">scales</span>::<span class="kw"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span>(datum=<span class="fl">NA</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(title=<span class="st">"DAs within City of Vancouver skytrain station catchments"</span>,
       fill=<span class="st">"Walk or\ntransit\nto work"</span>,
       caption=<span class="st">"StatCan Census 2016"</span>)
</pre></div>
<p><img src="intersecting_geometries_files/figure-html/unnamed-chunk-6-1.png" width="700"></p>
<p>However, API points for <code>get_intersecting_geometries</code> are quite limited at this point, an alternative way to obtain the same data is to first query all DAs withing the CTs identified by the previous <code>get_intersecting_geometries</code> call and then filter down to those intersecting the station buffers.</p>
<div class="sourceCode" id="cb7"><pre class="downlit">
<span class="kw">station_das2</span> <span class="op">&lt;-</span> <span class="fu"><a href="../reference/get_census.html">get_census</a></span>(<span class="st">"CA16"</span>, regions = <span class="kw">station_ct_ids</span>, vectors=<span class="kw">variables</span>, 
                           geo_format = <span class="st">'sf'</span>, level=<span class="st">"DA"</span>, quiet=<span class="fl">TRUE</span>) <span class="op">%&gt;%</span>
  <span class="kw">sf</span>::<span class="fu"><a href="https://rdrr.io/pkg/sf/man/st_join.html">st_filter</a></span>(<span class="kw">cov_station_buffers</span>)

<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggplot.html">ggplot</a></span>(<span class="kw">station_city</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(fill=<span class="fl">NA</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(data=<span class="kw">station_das2</span>,<span class="fu"><a href="https://ggplot2.tidyverse.org/reference/aes.html">aes</a></span>(fill=((<span class="kw">walk</span><span class="op">+</span><span class="kw">transit</span>)<span class="op">/</span><span class="kw">mode_base</span>))) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">geom_sf</a></span>(data=<span class="kw">cov_station_buffers</span>,fill=<span class="fl">NA</span>,alpha=<span class="fl">0.5</span>,color=<span class="st">"steelblue"</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/scale_viridis.html">scale_fill_viridis_c</a></span>(option=<span class="st">"magma"</span>,labels=<span class="kw">scales</span>::<span class="kw"><a href="https://scales.r-lib.org/reference/label_percent.html">percent</a></span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/ggsf.html">coord_sf</a></span>(datum=<span class="fl">NA</span>) <span class="op">+</span>
  <span class="fu"><a href="https://ggplot2.tidyverse.org/reference/labs.html">labs</a></span>(title=<span class="st">"DAs within City of Vancouver skytrain station catchments"</span>,
       fill=<span class="st">"Walk or\ntransit\nto work"</span>,
       caption=<span class="st">"StatCan Census 2016"</span>)
</pre></div>
<p><img src="intersecting_geometries_files/figure-html/unnamed-chunk-7-1.png" width="700"></p>
<p>We may increase the default quotas for the <code>get_intersecting_geometries</code> call at some point, but while we throttling API usage and monitor server impacts of the new functionality it may be preferable to use the <code>get_intersecting_geometries</code> call for higher level geographies only and add a few lines of code to do the final bit of filtering in R.</p>
</div>
<div id="addendum" class="section level2">
<h2 class="hasAnchor">
<a href="#addendum" class="anchor"></a>Addendum</h2>
<p>We may take this further by estimate values of census variables strictly within catchments areas. Rather than intersecting, some adjustments for spatial disaggregation and interpolation are needed. The <code>tongfen_estimate</code> method from the <a href="https://mountainmath.github.io/tongfen/index.html"><code>tongfen</code> package</a> is useful in this case. This is a related package that is designed to work in tandem with <code>cancensus</code> in order to facilitate census geography aggregation and is designed to make census data comparable across several censuses.</p>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by <a href="https://mountainmath.ca">Jens von Bergmann</a>, <a href="https://dshkol.com">Dmitry Shkolnik</a>, Aaron Jacobs.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.6.1.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
